name: Daily Bet Update

on:
  schedule:
    - cron: "0 8 * * *"  # 08:00 UTC ~= 10:00 norsk tid (CET/CEST)
  workflow_dispatch:

permissions:
  contents: write  # trengs for Ã¥ pushe bet_history.csv

jobs:
  update-bets:
    runs-on: ubuntu-latest
    concurrency:
      group: daily-bet-update
      cancel-in-progress: false
    env:
      REQUIREMENTS_FILE: NHL/requirements-api.txt
      PREDICTIONS_SCRIPT: NHL/generate_predictions.py
      EXTRA_PYPI_PACKAGES: "matplotlib tabulate"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r "$REQUIREMENTS_FILE"
          pip install $EXTRA_PYPI_PACKAGES

      - name: Download latest model artifact (best effort)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ARTIFACT_NAME: nhl-model
        run: |
          set -euo pipefail
          mkdir -p NHL/models
          api="https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/artifacts?per_page=100"
          response=$(curl -sS -H "Authorization: Bearer $GH_TOKEN" "$api" || true)
          if [ -z "$response" ]; then
            echo "No response from artifact API, will train if needed."
            exit 0
          fi
          url=$(python - <<'PY'
          import os, sys, json
          data_str = sys.stdin.read().strip()
          if not data_str:
              sys.exit(0)
          try:
              data = json.loads(data_str)
          except Exception:
              sys.exit(0)
          target = os.environ.get("ARTIFACT_NAME", "nhl-model")
          for art in data.get("artifacts", []):
              if art.get("name") == target and not art.get("expired"):
                  print(art.get("archive_download_url", ""))
                  break
          PY
          )
          if [ -z "$url" ]; then
            echo "No model artifact found, will train if needed."
            exit 0
          fi
          echo "Downloading model artifact: $ARTIFACT_NAME"
          curl -L -H "Authorization: Bearer $GH_TOKEN" -o /tmp/model.zip "$url"
          unzip -o /tmp/model.zip -d NHL/models

      - name: Ensure model artifact
        working-directory: NHL
        run: |
          if [ -f models/nhl_model.pkl ]; then
            echo "Existing model found"
          else
            echo "Model missing, training a fresh one..."
            python train_model.py
          fi

      - name: Upload model artifact
        uses: actions/upload-artifact@v4
        with:
          name: nhl-model
          path: NHL/models/nhl_model.pkl
          if-no-files-found: error
          retention-days: 30

      - name: Run daily bet update
        working-directory: NHL
        run: |
          python bet_tracker.py

      - name: Generate daily predictions assets
        env:
          MPLCONFIGDIR: /tmp/mplcache
        run: |
          python "$PREDICTIONS_SCRIPT"

      - name: Commit and push changes
        run: |
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add NHL/data/bet_history.csv docs/predictions.png docs/TODAY.md docs/portfolio.png docs/daily_profit.png

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "chore: daily bet + predictions update"
          git push
